## 트랜잭션
- myisam, memory 스토리지 엔진은 트랜잭션을 지원하지 않는다.
- 코드에서 트랜잭션의 범위를 최소화 하는게 좋다. 특히 외부통신

## mysql 엔진의 잠금
- 스토리지 엔진 레벨과 mysql엔진 레벨로 나뉘어 진다.
  - mysql엔진 레벨은 모든 스토리지에 영향을 미치지만, 스토리지 엔진 레벨은 상호 영향을 미치지 않는다.

### 글로벌 락
- mysql에서 제공하는 잠금 중에 가장 범위가 크다
  - mysql서버 전체, 디비 및 테이블이 달라도 동일하게 영향을 미침
  - 한 세션에서 락 획득 시, select를 제외한 모든 쿼리가 대기
  - 8.0부터는 백업락 도입
    - 일반적인 테이블의 데이터 변경 허용, 주로 레플리카에서 실행
   
### 테이블 락
- 테이블 단위로 설정되는 락
- 명시적, 묵시적으로 획득 가능
  - myisam, memory 테이블의 데이터를 변경하는 쿼리 실행 시
  - innodb: 스키마를 변경하는 ddl 실행 시
 
### 네임드 락
- get_lock() 함수로 문자열에 대해 잠금을 설정할 수 있다.
- 사용자가 지정한 문자열에 대해 획득하고 반납하는 잠금이다.

### 메타데이터 락
- 데이터베이스 객체(테이블이나 뷰 등)의 이름이나 구조 변경 시 획득하는 잠금
- 명시적으로 획득할 수 없고 rename ~ 같이 테이블의 이름을 변경할 시 자동 획득

## innodb 스토리지 엔진 잠금
- 스토리지 엔진 내부에서 레코드 기반의 잠금 방식을 채택하고 있다.

### 레코드 락
- 레코드 자체만을 잠그는 락, innodb는 레코드 자체가 아니라 인덱스의 레코드를 잠근다.
- 인덱스가 없어도 내부적으로 자동생성된 클러스터 인덱스를 이용해 잠금을 설정한다.
- pk, unique 인덱스에 의한 변경작업에서는 갭에 대해서 잠그지 않고 레코드 자체에 대해서만 락을건다.

### 갭 락
- 레코드 자체가 아니라 레코드와 바로 인접한 레코드 사이의 간격만을 잠근다.
- 레코드와 레코드 사이의 간격에 새로운 레코드가 생성되는것을 제어한다.

### 넥스트 키 락
- 레코드락 + 갭락
- 바이너리 로그에 기록되는 쿼리가 레플리카에서 실행될 때, 동일한 결과를 만들어내도록 보장하는것이 주 목적
- 넥스트 키 락, 갭 락으로 데드락이 발생하거나 다른 트랜잭션을 기다리게 만드는 일이 자주 발생한다.

### 자동 증가 락
- auto-increament가 중복되지 않고 저장된 순서대로 증가해야 하기때문에 테이블 수준의 잠금을 사용한다.
- 트랜잭션과 상관없이 insert시 auto-increament 값을 가져오는 순간만 락이 걸렸다 즉시 해제된다.
- 테이블 마다 단 하나만 존재해서 insert가 동시에 실행되면 해제될때 까지 기다려야 한다.
- 명시적으로 획득하고 해제하는 방법은 없다.
- 5.1 부터는 insert 숫자를 정확하게 예측할 수 있을때는 자동증가락 대신 래치(뮤택스)를 이용한다.
  - 8.0 부터는 기본적으로 무조건 래치를 사용함.
  - 짧은 시간동안 잠금을 걸고 필요한 여러개의 자동 증가 값을 할당받아 가져옴
- 자동 증가 값이 절대 줄어들지 않는 이유는 auto-increament 잠금을 최소화 하기 위함이다. 



















### 처리율 제한 장치
트래픽의 처리율을 제어하기 위한 장치, 임계치를 넘어가면 모든 호출은 처리가 중단된다.
* ex)
  * 사용자는 초당 2회 이상의 새글을 올릴 수 없다.
  * 같은 ip주소로 하루에 10개 이상의 계정생성 불가
  * 같은 디바이스로 주당 5회 리워드 요청금지
* 장점
  * 디도스 공격에 의한 자원고갈 방지
  * 비용 절감
  * 서버 과부하를 막을 수 있다.

<br>

### 처리율 제한 알고리즘
* 토큰 버킷 (token bucket)
* 누출 버킷 (leaky bucket)
* 고정 윈도 카운터 (fixed window counter)
* 이동 윈도 로그 (sliding window log)
* 이동 윈도 카운터 (sliding window counter)

<br>

### 처리율 제한의 카운터는 어디 보관할 것인가?
* 디스크 접근 없는 캐시서버

<br>

### 개략적 구조
클라이언트 -> 처리율 제한 미들웨어 -> 캐시 서버 -> API 서버
* 캐시서버의 지정 버킷에서 검사 후 요청 거부 또는 API서버로 전달

<br>

### 상세 설계
* 처리율 제한 규칙은 보통 설정 파일 형태로 디스크에 저장하고 작업 프로세스는 수시로 규칙을 읽어 캐시에 저장한다.
* 요청은 먼저 처리율 제한 미들웨어에 도달한다.
* 처리율 제한 미들웨어는 규칙을 캐시에서 가져온다.
* 제한에 걸렸다면 429 too many requests 오류를 X-Ratelimit-Retry-After 헤더와 함께 반환한다.
  * X-Ratelimit-Retry-After 헤더: 클라이언트가 언제 다시 요청을 보내야 하는지
 
<br>

### 분산환경에서의 처리율 제한 장치
* 경쟁조건
  * 락 대신 사용할 수 있는 해결책
    * 루아 스크립트
    * redis sorted set
* 동기화
  * 처리율 제한 장치 서버가 한대가 아닐 경우
  * 분산 환경에서 세션 스토리지를 redis로 사용하는 것처럼 redis사용
 
<br>

### 성능 최적화
* 가까운 데이터 센터 이용
* 제한 장치 간 동기화에 최종 일관성 모델 사용

<br>

### 클라이언트 측
* 클라이언트측 캐시를 사용해 API 호출 횟수 줄이기
* 처리율 제한 임계치를 이해하고, 짧은시간에 많은 메시지를 보내지 말기
* 예외처리를 graceful 하게 하기
* retry는 충분한 백오프 시간을 두기

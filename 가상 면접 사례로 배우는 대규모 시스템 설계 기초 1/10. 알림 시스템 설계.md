## 개략적 설계안
### 알림 유형별 지원 방안
#### ios
* 알림제공자: 알림요청을 만들어 APNS로 보내는 주체
  * 단말토큰: 알림요청을 보내는데 필요한 고유 식별자
  * 페이로드: 알림내용을 담은 JSON
* APNS: 애플이 제공하는 원격서비스. 푸시알림을 ios로 보내는 역할
* ios 단말

#### android
* ios와 비슷하지만 APNS대신 FCM(Firebase Cloud Messaging)을 사용

#### sms메시지
* 비슷하다.
* 보통 트위일로, 넥스모 같은 제3자 유료 서비스를 사용한다

#### 이메일
* 비슷하다.
* 상용 이메일 서비스 사용.

<br>

### 연락처 정보 수집 절차
* 알림을 보내기 위해선 모바일 단말토큰, 전화번호, 이메일 주소등이 필요함 (회원가입 시 db저장)
* 보통 이메일주소, 전화번호는 user 테이블에 단말토큰은 device 테이블에 저장 (사용자는 여러 단말을 가질 수 있음)

<br>

### 알림 전송 및 수집 절차
#### 초안
* SPOF 방지: 다수의 알림서비스 서버
* 규모 확장성: 한대의 서비스로 푸시알림에 모든것을 처리하지 말것.
* 성능 병목: 알림서비스는 자원이 많이 필요하기 때문에 한대의 서버는 트래픽이 몰릴때 과부하 상태에 빠짐.

<br>

#### 개선안
* DB와 캐시를 알림시스템 주 서버에서 분리
* 알림서버를 증설하고 자동으로 scale-out이 이루어 질수 있도록 설계
* 메시지큐를 이용해 컴포넌트간의 강한 결합을 끊는다.
* 알림서버
  * 인증된 클라이언트만 사용 가능
  * 알림 검증
  * DB또는 캐시 질의
  * 알림 전송 (메시지큐에 write)
* 작업 서버
  * 메시지큐에서 작업을 꺼내 제 3자 서비스로 전달 하는 역할

<br>

### 상세 설계
#### 안정성
* 데이터 손실 방지
  * 알림 로그 db를 유지
* 알림 중복 전송 방지
  * 중복전송을 100% 막는것은 힘들다.
  * 이벤트 id등을 통해 중복전송 최대한 방지

<br>

#### 추가로 필요한 컴포넌트 및 고려사항
* 알림템플릿
* 알림설정
  * 알림설정 테이블에 보관하여 알림을 보내기 전 참조
* 전송률 제한
* 전송 실패 시 재시도 전용 큐에 넣음
* 푸시 알림과 보안
* 큐 모니터링
  * 큐의 사이즈가 너무 커지면 작업서버를 증설
* 이벤트 추적












### 개략적 설계안
- 로드밸런서
  - http, webSocket
- restful api 서버
  - 친구 추가/삭제, 정보 갱신 등
- 웹소켓 서버
  - 친구 위치 정보를 실시간에 가깝게 처리하는 유상태 서버 클러스터
- 레디스 위치정보 캐시
  - 활성상태 사용자의 최근 위치정보 캐시
  - ttl 전략
- 사용자 데이터베이스
  - 사용자의 위치 변동 이력 보관
- 레디스 pub/sub
  - 초경량 메시지 버스
  - 새로운 채널을 생성하는것은 아주 값싼 연산
  - 위치정보 변경 이벤트를 해당 사용자에게 배정된 채널에 배정
  - 해당 채널의 구독자에게 전파
 
### 상세 설계
- 웹소켓 서버
  - 기존 서버를 제거할때 기존연결부터 종료되도록 설계
- 사용자 데이터베이스
  - 사용자 상세정보, 친구관계 데이터 저장
  - 관계형 디비의 경우 샤딩을 통한 수평확장 필수
- 위치 정보 캐시
  - ttl을 설정해두고 위치정보가 갱신될때마다 초기화
  - 샤딩이 필요하면 사용자 id를 기준한다.
- 레디스 pub/sub 서버
  - 모든 온라인 친구에게 보내는 위치정보 변경내역 메시지의 라우팅 계층으로 활용
  - 채널 생성비용이 아주 저렴
  - 병목은 메모리가 아닌 cpu사용량
  - 클러스터 구성을 해야함
  - 서비스 탐색 컴포넌트 도입
    - 설정 데이터를 보관하기 위한 키-값 저장소 역할
    - 안정해시 알고리즘
  - 규모 확장 고려사항
    - 관점에 따라 pub/sub 서버는 무상태, 유상태 둘다 해당하기 때문에 유상태라 가정한다.
    - 오버 프로비저닝
    - 안정해시 재설계로 엄청난 재구독 발생
    - 어느정도의 손실 감수
    - 클러스터 크기 조정은 트래픽이 가장 낮을 때 시행
- 친구 추가/삭제
  - 웹소켓 연결 핸들러 요청
  - 새친구의 pub/sub 채널 구독/삭제
- 친구가 많은 사용자
  - 구독관계가 분산되어있기 때문에 핫스팟 문제는 없을 거임
  - 양방향인 친구관계의 상한선을 두는 운영적인 제한
- 주변의 임의 사용자
  - 지오해시에 따라 구축된(격자마다) pun/sub 채널 풀을 둔다.
  - 해당 격자 내의 사용자는 격자에 할당된 채널을 구독
- 레디스 pub/sub외의 대안
  - 많다.




















